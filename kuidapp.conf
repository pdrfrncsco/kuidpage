server {
    listen 80;
    server_name kuid.ndeas.cloud;

    # Ajuste o caminho conforme sua estrutura real no servidor
    root /var/www/kukuid/kuidpage/dist;
    index index.html;

    # Compressão Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;

    # Redirecionamento HTTPS Global (Segurança para todas as rotas)
    # Se não for HTTPS e não vier da Cloudflare como HTTPS, redireciona
    if ($http_x_forwarded_proto != "https") {
        rewrite ^ https://$host$request_uri? permanent;
    }

    # 1. ARQUIVOS DE CONTROLE (NUNCA CACHEAR)
    location ~* ^/(index\.html|sw\.js|manifest\.webmanifest)$ {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        expires off;
    }

    # 2. ATIVOS COM HASH (CACHE AGRESSIVO - 1 ANO)
    # Usamos ^~ para garantir que esta regra ganhe das regexes de extensão abaixo
    location ^~ /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # 3. OUTROS ARQUIVOS ESTÁTICOS NA RAIZ (favicon, imagens soltas)
    location ~* \.(png|jpe?g|gif|svg|ico|webp|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public, must-revalidate";
        try_files $uri /index.html;
    }

    # 4. ROTEAMENTO PARA SPA (React Router)
    location / {
        try_files $uri /index.html;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
    }
}
